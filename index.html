<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width">
<title>Sticky Graph</title>
<link rel="stylesheet" type="text/css" href="StickyGraph.css">

<body>
<!-- <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script> -->
<script src="d3.min.js"></script>
<script src="graphIO.js"></script>
<script src="eventListeners.js"></script>
<script src="graphEditing.js"></script>
<!-- Load these scripts in a non blocking way where possible -->

<div id="drawing-board-div"></div>



<form id="graph-input-form" action="" onsubmit="return load_graph();">
<select id="graph-mode-input" onchange="set_graph_mode()">
	<option value="graph6">Graph6</option>
	<!-- <option value="pathlist" disabled="disabled">Path List</option> -->
	<option value="edgelist">Edge List</option>
	<option value="togglematrix">Interactive A.M.</option>
	<option value="adjmatrix">Adj. Matrix</option>
	<option value="adjlist">Adj. List</option>
	<option value="laplacian">Laplacian</option>
	<option value="normlaplacian">N. Laplacian</option>
	<option value="none">None</option>
</select>
<input type="text" id="graph-input" value="" size="30" autofocus>
<input type="submit" id="submit-button" value="Draw!"/>
<textarea id="matrix-area" readonly wrap="off" style="display:none;"></textarea>
<table id="togglematrix-table" style="text-align:center;font-size:12px;">
</table>
<!--  contenteditable: http://html5demos.com/contenteditable -->
</form>

<text id="keyboard-info"></text>

<script>

var width = window.innerWidth,
	height = window.innerHeight;

const DRAGPIN   = 0, // modes
      ADDEDGE   = 1,
      CONTRACT  = 2,
      DELETE    = 3,
      ADDVERTEX = 4,
      COLOR     = 5;
var mode = DRAGPIN;
var colorMode = ""; // this would be the color if we are in color mode. Otherwise unused.
var graphMode;

var nodes = [],
	links = [];

var adjmatix = [];

var nextIDv = 0, nextIDe = 0; // when we edit the graph, maybe it would help to have a nice, unique id to go along with it? maybe we don't need ids at all, though?

var undoStack = [],
	redoStack = [];

var force = d3.layout.force()
	.nodes(nodes)
	.links(links)
	.charge(-600)
	.gravity(.1)
	.linkDistance(120)
	.size([width, height])
	.on("tick", tick)
	/* .linkStrength(.8); */
	.linkStrength(
		function(d,i)
		{
			while (i--)
				if (links[i].source == d.source && links[i].target == d.target || links[i].target == d.source && links[i].source == d.target)
					return 0;
			return .8;
		});

var drag = force.drag()
	.on("dragstart", drag_pin_drag_start)
	.on("drag", drag_pin_drag)
	.on("dragend", drag_pin_end);
set_graph_mode();

var zoom = d3.behavior.zoom();

var drawingBoard = d3.select("#drawing-board-div")
	.append("svg")
	.attr("id", "drawing-board")
	.attr("preserveAspectRatio", "xMinYMin meet");

var addvButton = d3.select("body")
	.append("svg")
	.attr("id", "add-v-button-svg")
	.classed("edit-button",true);
addvButton.append("rect")
	.classed("edit-button-rect mode-button", true)
	.attr("id", "add-v-button")
	.on("click", add_vertex_button_press);
addvButton.append("path")
	.classed("edit-button-path", true)
	.attr("d","M 13 0 L -13 0 M 0 13 L 0 -13");
addvButton.append("text")
	.classed("edit-button-text", true)
	.attr("x","9")
	.attr("y","9")
	.text("v");

var addeButton = d3.select("body")
	.append("svg")
	.attr("id", "add-e-button-svg")
	.classed("edit-button",true);
addeButton.append("rect")
	.classed("edit-button-rect mode-button", true)
	.attr("id", "add-e-button")
	.on("click", add_edge_button_press);
addeButton.append("path")
	.classed("edit-button-path", true)
	.attr("d","M 13 0 L -13 0 M 0 13 L 0 -13");
addeButton.append("text")
	.classed("edit-button-text", true)
	.attr("x","9")
	.attr("y","9")
	.text("e");

var deleteButton = d3.select("body")
	.append("svg")
	.attr("id", "delete-button-svg")
	.classed("edit-button",true);
deleteButton.append("rect")
	.classed("edit-button-rect mode-button", true)
	.attr("id", "delete-button")
	.on("click", delete_button_press);
deleteButton.append("path")
	.classed("edit-button-path", true)
	.attr("d","M -9.1924 9.1924 L 9.1924 -9.1924 M -9.1924 -9.1924 L 9.1924 9.1924");

var contractButton = d3.select("body")
	.append("svg")
	.attr("id", "contract-button-svg")
	.classed("edit-button",true);
contractButton.append("rect")
	.classed("edit-button-rect mode-button", true)
	.attr("id", "contract-button")
	.on("click", contract_button_press);
contractButton.append("path")
	.classed("edit-button-path", true)
	.attr("d","M -13 13 L 13 -13");

var selectAllButton = d3.select("body")
	.append("svg")
	.attr("id", "select-v-button-svg")
	.classed("edit-button",true);
selectAllButton
	.append("defs")
	.append("svg:clipPath")
	.attr("id", "clip")
	.append("rect")
	.attr({id:"clip-rect", x:-17, y:-10, width:34, height:20});
selectAllButton.append("rect")
	.classed("edit-button-rect", true)
	.on("click", select_vertices_button_press);
selectAllButton.append("path")
	.classed("link",true)
	.attr("d", "M 11 0 L 17 0 M -11 0 L -17 0")
	.attr("clip-path", "url(#clip)");
selectAllButton.append("circle")
	.classed("node selected", true)
	.attr({cx:"0px", cy:"0px", r:"5px"});


var selectEdgesButton = d3.select("body")
	.append("svg")
	.attr("id", "select-e-button-svg")
	.classed("edit-button",true);
selectEdgesButton.append("rect")
	.classed("edit-button-rect", true)
	.on("click", select_edges_button_press);
selectEdgesButton.append("path")
	.classed("link selected",true)
	.attr("d", "M 11 0 L 17 0 M -11 0 L -17 0")
	.attr("clip-path", "url(#clip)");
selectEdgesButton.append("circle")
	.classed("node", true)
	.attr({cx:"0px", cy:"0px", r:"5px"});


var selectNoneButton = d3.select("body")
	.append("svg")
	.attr("id", "select-none-button-svg")
	.classed("edit-button",true);
selectNoneButton.append("rect")
	.classed("edit-button-rect", true)
	.on("click", select_none);
selectNoneButton.append("path")
	.classed("link",true)
	.attr("d", "M 11 0 L 17 0 M -11 0 L -17 0")
	.attr("clip-path", "url(#clip)");
selectNoneButton.append("circle")
	.classed("node", true)
	.attr({cx:"0px", cy:"0px", r:"5px"});


var pinButton = d3.select("body")
	.append("svg")
	.attr("id", "pin-button-svg")
	.classed("edit-button",true);
pinButton.append("rect")
	.classed("edit-button-rect", true)
	.on("click", pin_button_press);
pinButton.append("path")
	.classed("link",true)
	.attr("d", "M 11 0 L 17 0 M -11 0 L -17 0")
	.attr("clip-path", "url(#clip)");
pinButton.append("circle")
	.classed("node pinned", true)
	.attr({cx:"0px", cy:"0px", r:"5px"});


var unpinButton = d3.select("body")
	.append("svg")
	.attr("id", "unpin-button-svg")
	.classed("edit-button",true);
unpinButton.append("rect")
	.classed("edit-button-rect", true)
	.on("click", unpin_button_press);
unpinButton.append("path")
	.classed("link",true)
	.attr("d", "M 11 0 L 17 0 M -11 0 L -17 0")
	.attr("clip-path", "url(#clip)");
unpinButton.append("circle")
	.classed("node", true)
	.attr({cx:"0px", cy:"0px", r:"5px"});

var TikZButton = d3.select("body")
	.append("svg")
	.attr("id", "TikZ-button-svg")
	.classed("edit-button",true);
TikZButton.append("rect")
	.classed("edit-button-rect", true)
	.on("click", generate_TikZ);
var TikZText = TikZButton.append("text")
	.attr("id","TikZ-button-text")
	.attr({x:"0px", y:"6px"});
TikZText.append("tspan").text("Ti");
TikZText.append("tspan").text("k").style("font-style","italic");
TikZText.append("tspan").text("Z");

var labelButton = d3.select("body")
	.append("svg")
	.attr("id", "label-button-svg")
	.classed("edit-button",true);
var labelRect = labelButton.append("rect")
	.classed("edit-button-rect selected",true)
	.on("click", function () { 
		d3.select(this).classed("selected", !d3.select(this).classed("selected"));
		check_show_labels(); });
labelButton.append("path")
	.classed("edit-button-path", true)
	.attr("d","M -13 5.5 L 13 5.5 M -13 -5.5 L 13 -5.5 M 5.5 -13 L 5.5 13 M -5.5 -13 L -5.5 13");

var helpButton = d3.select("body")
	.append("svg")
	.attr("id", "help-button-svg")
	.classed("edit-button",true);
helpButton.append("rect")
	.classed("edit-button-rect",true)
	.on("click", function () { window.open('usage'); });
helpButton.append("path")
	.classed("edit-button-path", true)
	.attr("d","M -7,-5 C -7,-15 7,-15 7,-5 C 7,0 1,2 0,8 L 0,-6");
helpButton.append("circle")
	.attr({cx:"0px", cy:"12px", r:"2.5px"});

var multigraphButton = d3.select("body")
	.append("svg")
	.attr("id", "multigraph-button-svg")
	.classed("edit-button",true);
var multigraph = multigraphButton.append("rect")
	.classed("edit-button-rect", true)
	.on("click", multigraph_button_press);
multigraphButton.append("path")
	.classed("link",true)
	.attr("d", "M -10.07 4 Q 0 7 10.07 4");
multigraphButton.append("path")
	.classed("link",true)
	.attr("d", "M -10.07 -4 Q 0 -7 10.07 -4");
multigraphButton.append("circle")
	.classed("node", true)
	.attr({cx:"17px", cy:"0px", r:"2px"})
	.attr("clip-path", "url(#clip)");;
multigraphButton.append("circle")
	.classed("node", true)
	.attr({cx:"-17px", cy:"0px", r:"2px"})
	.attr("clip-path", "url(#clip)");;

var undoButton = d3.select("body")
	.append("svg")
	.attr("id", "undo-button-svg")
	.classed("edit-button",true);
undoButton.append("rect")
	.classed("edit-button-rect", true)
	.on("click", undo);
undoButton.append("path")
	.classed("edit-button-path", true)
	.attr("d","M 13 0 L -13 0 M -13 0 l 7 7 M -13 0 l 7 -7");

var redoButton = d3.select("body")
	.append("svg")
	.attr("id", "redo-button-svg")
	.classed("edit-button",true);
redoButton.append("rect")
	.classed("edit-button-rect", true)
	.on("click", redo);
redoButton.append("path")
	.classed("edit-button-path", true)
	.attr("d","M -13 0 L 13 0 M 13 0 l -7 7 M 13 0 l -7 -7");

var colors = ["magenta", "red", "orange", "yellow", "green", "cyan", "blue", "violet"];
var colorstring = colors.join(" ");

d3.select("body")
	.append("svg")
	.attr("id", "no-color-button-svg")
	.classed("color-button-svg",true)
	.append("rect")
	.classed("color-button-rect mode-button", true)
	.attr("id", "no-color-button")
	.on("click", function () {color_button_press("");})
	.style("fill", "black");

for (var color of colors)
{
	var f = function(c) {return function() {color_button_press(c);};};
	d3.select("body")
		.append("svg")
		.attr("id", color+"-button-svg")
		.classed("color-button-svg",true)
		.append("rect")
		.classed(color,true)
		.classed("color-button-rect mode-button", true)
		.attr("id", color+"-button")
		.on("click", f(color));
}

d3.selectAll(".color-button-svg")
	.attr("viewBox", "-20 -20 40 40 ")
	.attr("width", "35")
	.attr("height", "35");

d3.selectAll(".edit-button")
	.attr("viewBox", "-20 -20 40 40 ")
	.attr("width", "35")
	.attr("height", "35");

d3.selectAll(".edit-button-path")
	.attr("stroke-linecap","round");

d3.selectAll(".edit-button-rect")
	.attr({x:"-18.5px", y:"-18.5px", width:"37px", height:"37px", rx:"6px", ry:"6px"});

d3.selectAll(".color-button-rect")
	.attr({x:"-18.5px", y:"-18.5px", width:"37px", height:"37px", rx:"6px", ry:"6px"});

d3.select("body").append("div").attr("id", "TikZ-div").style("display", "none").append("textarea").attr("id", "TikZ-area").attr({id:"TikZ-area", readonly:true, wrap:"off"}).style("width", ""+(width/3)+"px");

var overlay = drawingBoard.append("rect")
	.attr("class", "overlay")
	.call(zoom.scaleExtent([.1, 8]).on("zoom", zoomHandler))
	.on("gesturechange", function () { d3.event.preventDefault(); })
	.on("gesturestart", function () { d3.event.preventDefault(); });

resize();
d3.select(window).on("resize", resize);

function resize() {
	var windowWidth = window.innerWidth, windowHeight = window.innerHeight;
	var dx = (windowWidth-width)/2, dy = (windowHeight-height)/2;
	drawingBoard.attr("viewBox", ""+(-dx)+" "+(-dy)+" "+(windowWidth)+" "+(windowHeight));
	overlay.attr({x:-dx, y: -dy, width:windowWidth, height: windowHeight});
	d3.select("#TikZ-area").style("max-width", ""+(windowWidth-104)+"px");
}

var zoomable = drawingBoard.append("g");

zoomable.append("g").attr("id", "links");
zoomable.append("g").attr("id", "nodes");
zoomable.append("g").attr("id", "labels");

var node = drawingBoard.select("#nodes").selectAll(".node"),
	link = drawingBoard.select("#links").selectAll(".link-parent"),
	label = drawingBoard.select("#labels").selectAll(".label");

function zoomHandler()
{
	zoomable.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
}

function getRandom(min, max) { return Math.random() * (max - min) + min; }

function xor(a,b) { return a?!b:b; }

function dist(x1,y1,x2,y2) { return Math.sqrt((x1-x2)*(x1-x2) + (y1-y2)*(y1-y2)); }

function unpin(d)
{
	if (d.fixed & 1)
	{
		float_nbr_edges(d);
		force.resume();
	}
	d.fixed &= 6;
	d3.select(this).classed("pinned", false);
}

function pin(d)
{
	d3.select(this).classed("pinned", d.fixed |= 1);
}

function change_mode(m, c)
{
	d3.selectAll(".mode-button").classed("selected", false);
	mode = m;
	colorMode = c;
	switch (mode)
	{
		case DRAGPIN: break;
		case ADDEDGE:
			d3.select("#add-e-button").classed("selected", true);
			break;
		case ADDVERTEX:
			d3.select("#add-v-button").classed("selected", true);
			break;
		case CONTRACT:
			d3.select("#contract-button").classed("selected", true);
			break;
		case DELETE:
			d3.select("#delete-button").classed("selected", true);
			break;
		case COLOR:
			if (c == "")
				d3.select("#no-color-button").classed("selected", true);
			else
				d3.select("#" + c + "-button").classed("selected", true);
			break;
		default:
			console.error("unrecognized mode:" + m);
	}
	add_event_listeners();
}

function add_event_listeners()
{
	switch (mode)
	{
	case DRAGPIN:
	case CONTRACT:
	case DELETE:
	case COLOR:
		link.selectAll(".link-background").call(curveEdgeDrag);
		node.call(drag);
		break;
	case ADDEDGE:
		link.selectAll(".link-background").call(curveEdgeDrag);
		node.call(addEdgeDrag);
		break;
	case ADDVERTEX:
		console.error("unsupported feature: interactive add vertex");
		break;
	}
	label.call(swapLabelsDrag);
}





function float_edge(d)
{
	if ("controlx" in d)
	{
		var v1 = d.source, v2 = d.target;
		var othercopies = [];
		for (l of links) // if (l != d)
			if (((l.source == v1 && l.target == v2) || (l.source == v2 && l.target == v1)) && !("controlx" in l))
				othercopies.push(l);
	
		var numcopies = othercopies.length; // the number of other (floating) copies of this edge

		for (l of othercopies)
			l.copies = numcopies;
		d.copies = d.copy = numcopies;
		delete d.controlx; delete d.controly;
	}
}

function unfloat_edge(d)
{
	if (!("controlx" in d)) // if it was floating
	{
		for (l of links) if (l != d)
		{
			if ((l.source.id == d.source.id && l.target.id == d.target.id || l.source.id == d.target.id && l.target.id == d.source.id) && !("controlx" in l))
			{
				l.copies--;
				if (l.copy > d.copy)
					l.copy--;
			}
		}
	}
}



// node.transition().duration(500).tween("", function(d) {var xinterp = d3.interpolateNumber(d.x, 500), yinterp = d3.interpolateNumber(d.y, 500); return function(t){d.x = d.px = xinterp(t); d.y = d.py = yinterp(t); tick();};}).ease("cubic-in").each("end", clear_graph)













function check_show_labels()
{
	if (labelRect.classed("selected"))
		label.attr("visibility", "visible");
	else
		label.attr("visibility", "hidden");
}

function clear_graph()
{
	zoom.scale(1);
	zoom.translate([0,0]);
	zoomable.attr("transform", "");
	links.length=0;
	nodes.length=0;
	
	update_graph();
}

function update_graph()
{
	node = node.data(force.nodes(), function(d) { return d.id;});
	node
		.enter()
		.append("circle")
		.classed("node", true)
		.attr("id", function(d) {return "v"+d.id;})
		.attr("r", "5px")
		.each(function(d) {d3.select(this).classed(d.color, true);})
		.classed("pinned", function(d) {return d.fixed;});
	node.exit().remove();
	
	link = link.data(force.links(), function(d) { return d.id; });
	var newLinkParents = link.enter()
		.append("g").classed("link-parent", true);
	newLinkParents.append("path")
		.classed("link-background", true);
	newLinkParents.append("path")
		.classed("link", true)
		.each(function(d) {d3.select(this).classed(d.color, true);});
	link.exit().remove();
	
	label = label.data(force.nodes(), function(d) { return d.id;});
	label
		.text(function(d) { return d.index;})
		.enter()
		.append("text")
		.classed("label", true)
		.text(function(d) { return d.index;});
	label.exit().remove();
	add_event_listeners();
	check_show_labels();
}

function tick()
{
	node.attr("cx", function(d) { return d.x; })
		.attr("cy", function(d) { return d.y; });
	
	link.selectAll("path").attr("d", get_edge_path);
	link.selectAll(".link").style("stroke-dasharray", function (d) {return "" + (this.getTotalLength()-22) + " 11";});
	
	label.attr("x", function(d) { return d.x; })
		.attr("y", function(d) { return d.y; })
		.attr("dy", "-14");
}

function get_state()
{
	var nodesClone = JSON.parse(JSON.stringify(nodes));
	var linksClone = [];
	for (var l of links)
	{
		if ("controlx" in l)
			linksClone.push({source: nodesClone[l.source.index], target: nodesClone[l.target.index], color: l.color, controlx: l.controlx, controly: l.controly, copy: l.copy, copies: l.copies, id: l.id});
		else
			linksClone.push({source: nodesClone[l.source.index], target: nodesClone[l.target.index], color: l.color, copy: l.copy, copies: l.copies, id: l.id});
		
	}
	return {nodes:nodesClone, links:linksClone, nextIDv:nextIDv, nextIDe:nextIDe, multimode:multigraph.classed("selected")};
}
function save_state()
{
	undoStack.push(get_state());
	redoStack.length = 0;
}

function load_state(state)
{
	multigraph.classed("selected", state.multimode);
	links.length=0;
	nodes.length=0;
	update_graph();
	for (var n of state.nodes)
		nodes.push(n);
	for (var l of state.links)
		links.push(l);
	nextIDv = state.nextIDv;
	nextIDe = state.nextIDe;
	update_graph();
	write_graph();
	force.start();
}

function undo()
{
	clearKeyMode();
	if (undoStack.length == 0)
		return;
	redoStack.push(get_state());
	load_state(undoStack.pop());
}

function redo()
{
	clearKeyMode();
	if (redoStack.length == 0)
		return;
	undoStack.push(get_state());
	load_state(redoStack.pop());
}

</script>

</body>
</html>
